rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // 1. HELPER FUNCTIONS
    // =========================================================
    function isLoggedIn() {
      return request.auth != null;
    }

    // Role lookup logic
    function getRole() {
      return isLoggedIn() && exists(/databases/$(database)/documents/staff/$(request.auth.uid)) && 
             'role' in get(/databases/$(database)/documents/staff/$(request.auth.uid)).data
        ? get(/databases/$(database)/documents/staff/$(request.auth.uid)).data.role
        : (isLoggedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
           'role' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
          : null);
    }

    function isAdmin() {
      let role = getRole();
      return role == "admin" || role == "Admin" || role == "SuperAdmin" || role == "superadmin" || role == "Super Admin";
    }
    
    function isSuperAdmin() {
      let role = getRole();
      return role == "SuperAdmin" || role == "superadmin" || role == "Super Admin";
    }

    function isFrontdesk() {
      let role = getRole();
      return role == "frontdesk" || role == "FrontDesk";
    }

    function isClinic() {
      let role = getRole();
      return role == "clinic" || 
             role == "Clinic" || 
             role == "ClinicalTeam" || 
             role == "Physiotherapist" || 
             role == "StrengthAndConditioning";
    }

    function isOwnStaffDoc() {
      return isLoggedIn() && (
        (resource != null && (
          ('authUid' in resource.data && request.auth.uid == resource.data.authUid) ||
          (request.auth.token.email != null && 
           'userEmail' in resource.data &&
           request.auth.token.email == resource.data.userEmail)
        )) ||
        ('authUid' in request.resource.data && request.auth.uid == request.resource.data.authUid) ||
        (request.auth.token.email != null && 
         'userEmail' in request.resource.data &&
         request.auth.token.email == request.resource.data.userEmail)
      );
    }

    // =========================================================
    // 2. CORE COLLECTIONS
    // =========================================================

    // USERS
    match /users/{uid} {
      allow read: if isLoggedIn() && (request.auth.uid == uid || isAdmin());
      allow write: if isAdmin() || request.auth.uid == uid;
    }

    // PATIENTS
    match /patients/{id} {
      allow read: if isLoggedIn();
      allow create, update: if isFrontdesk() || isAdmin() || isClinic() || 
                            (isLoggedIn() && 
                            (request.resource.data.keys().hasAny([
                              'complaints', 'presentHistory', 'pastHistory', 'med_xray', 'med_mri', 
                              'med_report', 'med_ct', 'surgicalHistory', 'per_smoking', 'per_drinking',
                              'per_alcohol', 'per_drugs', 'sleepCycle', 'hydration', 'nutrition',
                              'siteSide', 'onset', 'duration', 'natureOfInjury', 'typeOfPain',
                              'vasScale', 'aggravatingFactor', 'relievingFactor', 'rom', 'mmt',
                              'treatmentProvided', 'progressNotes', 'physioName', 'physioId',
                              'dateOfConsultation', 'referredBy', 'chiefComplaint', 'clinicalDiagnosis',
                              'treatmentPlan', 'followUpVisits', 'totalSessionsRequired', 'remainingSessions',
                              'currentPainStatus', 'currentRom', 'currentStrength', 'currentFunctionalAbility',
                              'complianceWithHEP', 'recommendations', 'physiotherapistRemarks',
                              'packageAmount', 'packageName', 'packageDescription', 'concessionPercent', 'paymentType', 'paymentDescription'
                            ])));
      allow delete: if isAdmin();
    }

    // APPOINTMENTS
    match /appointments/{id} {
      allow read: if isLoggedIn();
      // Staff can create any appointment; mobile app (authenticated) can create appointment *requests* only
      allow create: if isFrontdesk() || isAdmin() || isClinic() ||
        (isLoggedIn() && request.resource.data.status == 'requested' && request.resource.data.keys().hasAll(['patient', 'status']));
      allow update: if isFrontdesk() || isAdmin() || isClinic();
      allow delete: if isAdmin() || isFrontdesk() || isClinic();
    }

    // BILLING & CYCLES
    match /billing/{id} {
      allow read: if isLoggedIn();
      allow create, update: if isFrontdesk() || isAdmin() || isClinic();
      allow delete: if isAdmin();
    }
    match /billingCycles/{id} {
      allow read: if isLoggedIn();
      allow create, update, delete: if isFrontdesk() || isAdmin();
    }

    // AUDIT LOGS
    match /auditLogs/{id} {
      allow read: if isAdmin() || isSuperAdmin();
      allow create: if isLoggedIn();
      allow update, delete: if isAdmin() || isSuperAdmin();
    }

    // STAFF & ADMIN
    match /staff/{id} {
      allow read: if isLoggedIn();
      allow write: if isLoggedIn() && (isAdmin() || isOwnStaffDoc());
    }
    match /adminUsers/{id} {
      allow read: if isAdmin() || isSuperAdmin();
      allow write: if isSuperAdmin();
    }

    // LEAVE REQUESTS
    match /leaveRequests/{id} {
      allow read: if isLoggedIn();
      allow create: if isLoggedIn();
      allow update: if isLoggedIn() && (isAdmin() || (resource != null && resource.data.userId == request.auth.uid));
      allow delete: if isLoggedIn() && (isAdmin() || (resource != null && resource.data.userId == request.auth.uid));
    }

    // =========================================================
    // 3. TRANSFERS
    // =========================================================
    match /transferRequests/{id} {
      allow read: if isLoggedIn();
      allow create, update: if isClinic() || isFrontdesk() || isAdmin();
      allow delete: if isAdmin();
    }
    match /transferHistory/{id} {
      allow read: if isLoggedIn(); 
      allow create, update: if isClinic() || isFrontdesk() || isAdmin();
      allow delete: if isAdmin();
    }
    match /sessionTransfers/{id} {
      allow read: if isLoggedIn();
      allow create, update: if isClinic() || isFrontdesk() || isAdmin();
      allow delete: if isAdmin();
    }

    // =========================================================
    // 4. NOTIFICATIONS & PREFERENCES
    // =========================================================
    match /notificationPreferences/{uid} {
      allow read, write: if isLoggedIn() && (request.auth.uid == uid || isAdmin());
    }
    match /notifications/{notificationId} {
      allow read: if isLoggedIn() && resource.data.userId == request.auth.uid;
      allow create: if isLoggedIn() && request.resource.data.userId != null && request.resource.data.title != null && request.resource.data.message != null;
      allow update: if isLoggedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }
    match /appNotifications/{notificationId} {
      allow read: if isLoggedIn();
      allow create: if isLoggedIn() && request.resource.data.type != null && request.resource.data.title != null && request.resource.data.message != null;
      allow update: if isLoggedIn();
      allow delete: if isAdmin();
    }

    // =========================================================
    // 5. MESSAGING
    // =========================================================
    match /conversations/{conversationId} {
      allow read: if isLoggedIn() && request.auth.uid in resource.data.participants;
      allow create: if isLoggedIn() && request.auth.uid in request.resource.data.participants;
      allow update: if isLoggedIn() && request.auth.uid in resource.data.participants;
      allow delete: if isLoggedIn() && request.auth.uid in resource.data.participants;
    }
    match /messages/{messageId} {
      function isConversationParticipantForRead() {
        return isLoggedIn() && resource.data.conversationId != null && exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) && request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;
      }
      allow read, update: if isLoggedIn() && isConversationParticipantForRead();
      allow create: if isLoggedIn() && request.resource.data.senderId == request.auth.uid && request.resource.data.conversationId != null && request.resource.data.text != null;
      allow delete: if isAdmin();
    }

    // =========================================================
    // 6. OTHER COLLECTIONS
    // =========================================================
    match /headerConfigs/{configId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }
    match /reportVersions/{versionId} {
      allow read: if isLoggedIn(); // Allow all authenticated users to read report versions
      allow create: if isLoggedIn() && (isClinic() || isFrontdesk() || isAdmin());
      allow update, delete: if isAdmin();
    }
    match /strengthConditioningReports/{reportId} {
      allow read, create, update: if isLoggedIn() && (isClinic() || isFrontdesk() || isAdmin());
      allow delete: if isAdmin();
    }

    // FIXED RULE: Updated to allow Clinical Team and Front Desk to delete versions
    match /strengthConditioningReportVersions/{versionId} {
      allow read, create: if isLoggedIn() && (isClinic() || isFrontdesk() || isAdmin());
      allow update, delete: if isLoggedIn() && (isClinic() || isFrontdesk() || isAdmin());
    }

    match /inventory/{id} {
      allow read: if isLoggedIn();
      allow write: if isFrontdesk() || isAdmin() || isSuperAdmin() || isClinic();
    }
    match /inventoryItems/{id} {
      allow read: if isLoggedIn();
      allow create, update, delete: if isFrontdesk() || isAdmin() || isSuperAdmin() || isClinic();
    }
    match /inventoryIssues/{id} {
      allow read: if isLoggedIn();
      allow create, update: if isFrontdesk() || isAdmin() || isSuperAdmin() || isClinic();
      allow delete: if isAdmin() || isSuperAdmin();
    }

    // SESSIONS - Allow authenticated users to read/write session data
    match /sessions/{id} {
      allow read, write: if isLoggedIn();
    }

    // =========================================================
    // 7. ACTIVITIES
    // =========================================================
    match /activities/{activityId} {
      allow read: if isLoggedIn() && (isClinic() || isAdmin());
      allow create: if isLoggedIn() && isClinic() && request.resource.data.staffEmail != null && request.resource.data.activityType != null && request.resource.data.startTime != null && request.resource.data.endTime != null;
      allow update: if isLoggedIn() && (isAdmin() || (isClinic() && resource != null && request.auth.token.email != null && (resource.data.staffEmail == null || resource.data.staffEmail == '' || resource.data.staffEmail.lower() == request.auth.token.email.lower() || resource.data.staffEmail == request.auth.token.email)));
      allow delete: if isLoggedIn() && (isAdmin() || (isClinic() && resource != null && resource.data.staffEmail != null && request.auth.token.email != null && resource.data.staffEmail.lower() == request.auth.token.email.lower()));
    }

    // =========================================================
    // 8. STAFF RATINGS
    // =========================================================
    match /staffRatings/{ratingId} {
      function isSpecificRater() {
        return isLoggedIn() && request.auth.token.email != null && (request.auth.token.email.lower() == 'dharanjaydubey@css.com' || request.auth.token.email.lower() == 'shajisp@css.com' || request.auth.token.email.lower() == 'nawazaman@css.com');
      }
      function isSpecificApprover() {
        return isLoggedIn() && request.auth.token.email != null && request.auth.token.email.lower() == 'antonychacko@css.com';
      }
      
      allow read: if isLoggedIn() && (
        (isAdmin() || isSuperAdmin() || isSpecificApprover()) || 
        (resource != null && resource.data.raterEmail == request.auth.token.email) || 
        (resource != null && resource.data.ratedStaffEmail != null && request.auth.token.email != null && resource.data.ratedStaffEmail.lower() == request.auth.token.email.lower())
      );

      allow create: if isLoggedIn() && (isSpecificRater() || isAdmin()) && request.resource.data.status == 'Pending';
      allow update: if isLoggedIn() && (isSuperAdmin() || isAdmin() || isSpecificApprover());
      allow delete: if isSuperAdmin() || isSpecificApprover();
    }
    
    // PATIENT REQUESTS (from mobile app)
    match /patientRequests/{requestId} {
      allow read: if isLoggedIn() && (isFrontdesk() || isAdmin() || isClinic());
      allow create: if isLoggedIn() && request.resource.data.patientName != null && request.resource.data.type != null && request.resource.data.message != null;
      allow update: if isLoggedIn() && (isFrontdesk() || isAdmin() || isClinic());
      allow delete: if isAdmin();
    }

    // RATING REQUESTS
    match /ratingRequests/{requestId} {
       function isAuthorizedRater() {
         return isLoggedIn() && request.auth.token.email != null && (request.auth.token.email.lower() == 'dharanjaydubey@css.com' || request.auth.token.email.lower() == 'shajisp@css.com');
       }
       allow read: if isLoggedIn() && (
         (resource != null && resource.data.requestedByEmail != null && request.auth.token.email != null && resource.data.requestedByEmail.lower() == request.auth.token.email.lower()) || 
         (isAuthorizedRater() && resource != null && resource.data.status == 'Pending')
       );
       allow create: if isLoggedIn() && request.resource.data.requestedById != null && request.resource.data.requestedByName != null && request.resource.data.requestedByEmail != null && request.resource.data.status == 'Pending' && request.auth.token.email != null && request.resource.data.requestedByEmail.lower() == request.auth.token.email.lower();
       allow delete: if isLoggedIn() && isAuthorizedRater();
    }

    // =========================================================
    // 9. DEFAULT DENY
    // =========================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}